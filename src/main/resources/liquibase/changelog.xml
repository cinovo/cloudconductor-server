<?xml version="1.0" encoding="UTF-8"?>
<!-- #%L cloudconductor-server %% Copyright (C) 2013 - 2014 Cinovo AG %% Licensed under the Apache License, Version 2.0 (the "License"); you
	may not use this file except in compliance with the License. You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0 
	Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT 
	WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations 
	under the License. #L% -->

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">
    <property name="now" value="sysdate" dbms="oracle"/>
    <property name="now" value="now()" dbms="mysql"/>
    <property name="now" value="now()" dbms="postgresql"/>
    <property name="now" value="now()" dbms="hsqldb"/>

    <changeSet id="1" author="psigloch" objectQuotingStrategy="QUOTE_ONLY_RESERVED_WORDS">
        <sql dbms="hsqldb,postgresql"><![CDATA[
			CREATE SCHEMA cloudconductor;
		]]></sql>

        <createTable tableName="package" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="description" type="varchar(1024)"/>
        </createTable>

        <createTable tableName="rpm" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="packageid" type="bigint">
                <constraints nullable="false" references="cloudconductor.package(id)" foreignKeyName="fk_rpm_pkg"
                             deleteCascade="true"/>
            </column>
            <column name="deprecated" type="boolean" defaultValueBoolean="false"/>
            <column name="version" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="dependency" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="type" type="integer">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
            <column name="operator" type="varchar(16)">
                <constraints nullable="false"/>
            </column>
            <column name="version" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="mappingrpmdep" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="dependencyid" type="bigint">
                <constraints nullable="false" references="cloudconductor.dependency(id)"
                             foreignKeyName="fk_dependency_rpm" deleteCascade="true"/>
            </column>
            <column name="rpmid" type="bigint">
                <constraints nullable="false" references="cloudconductor.rpm(id)" foreignKeyName="fk_rpm_dependency"
                             deleteCascade="true"/>
            </column>
        </createTable>

        <createTable tableName="sshkey" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="keycontent" type="varchar(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="owner" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>
        </createTable>

        <createTable tableName="template" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
            <column name="yum" type="varchar(200)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(1024)"/>
        </createTable>

        <createTable tableName="mappingrpmtemplate" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="templateid" type="bigint">
                <constraints nullable="false" references="cloudconductor.template(id)" foreignKeyName="fk_template_rpm"
                             deleteCascade="true"/>
            </column>
            <column name="rpmid" type="bigint">
                <constraints nullable="false" references="cloudconductor.rpm(id)" foreignKeyName="fk_rpm_template"
                             deleteCascade="true"/>
            </column>
        </createTable>

        <createTable tableName="host" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(1024)"/>
            <column name="templateid" type="bigint">
                <constraints nullable="false" references="cloudconductor.template(id)"
                             foreignKeyName="fk_host_template"/>
            </column>
            <column name="lastseen" type="bigint"/>
        </createTable>

        <createTable tableName="service" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(1024)"/>
            <column name="initscript" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="servicestate" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="serviceid" type="bigint">
                <constraints nullable="false" references="cloudconductor.service(id)"
                             foreignKeyName="fk_svcstate_svc_host" deleteCascade="true"/>
            </column>
            <column name="hostid" type="bigint">
                <constraints nullable="false" references="cloudconductor.host(id)" foreignKeyName="fk_svcstate_host_svc"
                             deleteCascade="true"/>
            </column>
            <column name="state" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="packagestate" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="rpmid" type="bigint">
                <constraints nullable="false" references="cloudconductor.rpm(id)"
                             foreignKeyName="fk_packagestate_rpm_host" deleteCascade="true"/>
            </column>
            <column name="hostid" type="bigint">
                <constraints nullable="false" references="cloudconductor.host(id)"
                             foreignKeyName="fk_packagestate_host_rpm" deleteCascade="true"/>
            </column>
        </createTable>

        <createTable tableName="mappingsvcpkg" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="pkgid" type="bigint">
                <constraints nullable="false" references="cloudconductor.package(id)" foreignKeyName="fk_pkg_svc"
                             deleteCascade="true"/>
            </column>
            <column name="svcid" type="bigint">
                <constraints nullable="false" references="cloudconductor.service(id)" foreignKeyName="fk_svc_pkg"
                             deleteCascade="true"/>
            </column>
        </createTable>

        <createTable tableName="mappinghostsvcst" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="hostid" type="bigint">
                <constraints nullable="false" references="cloudconductor.host(id)" foreignKeyName="fk_host_svc"
                             deleteCascade="true"/>
            </column>
            <column name="svcstid" type="bigint">
                <constraints nullable="false" references="cloudconductor.servicestate(id)"
                             foreignKeyName="fk_svcst_host" deleteCascade="true"/>
            </column>
        </createTable>

        <createTable tableName="mappingtemplatehost" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="templateid" type="bigint">
                <constraints nullable="false" references="cloudconductor.template(id)"
                             foreignKeyName="fk_template_maphost" deleteCascade="true"/>
            </column>
            <column name="hostid" type="bigint">
                <constraints nullable="false" references="cloudconductor.host(id)" foreignKeyName="fk_maphost_template"
                             deleteCascade="true"/>
            </column>
        </createTable>

        <createTable tableName="mappingtemplatesshkey" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="templateid" type="bigint">
                <constraints nullable="false" references="cloudconductor.template(id)"
                             foreignKeyName="fk_template_sshkey" deleteCascade="true"/>
            </column>
            <column name="sshkeyid" type="bigint">
                <constraints nullable="false" references="cloudconductor.sshkey(id)" foreignKeyName="fk_sshkey_template"
                             deleteCascade="true"/>
            </column>
        </createTable>

        <createTable tableName="configfile" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(150)">
                <constraints nullable="false"/>
            </column>
            <column name="targetpath" type="varchar(150)">
                <constraints nullable="false"/>
            </column>
            <column name="owner" type="varchar(150)">
                <constraints nullable="false"/>
            </column>
            <column name="filegroup" type="varchar(150)">
                <constraints nullable="false"/>
            </column>
            <column name="filemode" type="varchar(150)">
                <constraints nullable="false"/>
            </column>
            <column name="template" type="boolean">
                <constraints nullable="false"/>
            </column>
            <column name="reloadable" type="boolean">
                <constraints nullable="false"/>
            </column>
            <column name="checksum" type="varchar(200)"/>
            <column name="packageid" type="bigint">
                <constraints references="cloudconductor.package(id)" foreignKeyName="fk_configfile_pkg"
                             deleteCascade="true"/>
            </column>
        </createTable>

        <createTable tableName="mappingconfigfileservice" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="configfileid" type="bigint">
                <constraints references="cloudconductor.configfile(id)" foreignKeyName="fk_configfile_svc"
                             deleteCascade="true"/>
            </column>
            <column name="serviceid" type="bigint">
                <constraints references="cloudconductor.service(id)" foreignKeyName="fk_svc_configfile"
                             deleteCascade="true"/>
            </column>
        </createTable>

        <createTable tableName="configdata" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="configfileid" type="bigint">
                <constraints references="cloudconductor.configfile(id)" foreignKeyName="fk_cdata_cf"
                             deleteCascade="true"/>
            </column>
            <column name="data" type="text"/>
        </createTable>

        <createTable tableName="mappingconfigfiletemplate" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="configfileid" type="bigint">
                <constraints nullable="false" references="cloudconductor.configfile(id)"
                             foreignKeyName="fk_configfile_template"
                             deleteCascade="true"/>
            </column>
            <column name="templateid" type="bigint">
                <constraints nullable="false" references="cloudconductor.template(id)"
                             foreignKeyName="fk_template_configfile"
                             deleteCascade="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="2" author="psigloch">
        <createTable tableName="configvalues" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="template" type="varchar(255)" defaultValue="GLOBAL">
                <constraints nullable="false"/>
            </column>
            <column name="service" type="varchar(255)"/>
            <column name="configkey" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="varchar(255)"/>
        </createTable>
    </changeSet>

    <changeSet id="3" author="psigloch">
        <createTable tableName="servicedefaultstate" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="serviceid" type="bigint">
                <constraints nullable="false" references="cloudconductor.service(id)"
                             foreignKeyName="fk_svcdefstate_svc_template"
                             deleteCascade="true"/>
            </column>
            <column name="templateid" type="bigint">
                <constraints nullable="false" references="cloudconductor.template(id)"
                             foreignKeyName="fk_svcdefstate_template_svc"
                             deleteCascade="true"/>
            </column>
            <column name="state" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="yumserver" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="yumpath" type="varchar(150)"/>
            <column name="description" type="varchar(1024)"/>
        </createTable>

        <renameColumn tableName="template" oldColumnName="yum" newColumnName="yum_old" schemaName="cloudconductor"
                      columnDataType="varchar(200)"/>
        <addColumn tableName="template" schemaName="cloudconductor">
            <column name="yum" type="bigint">
                <constraints references="cloudconductor.yumserver(id)" foreignKeyName="fk_template_yum"
                             deleteCascade="true"/>
            </column>
        </addColumn>

        <sql>INSERT INTO cloudconductor.yumserver (yumpath) SELECT DISTINCT yum_old FROM cloudconductor.template</sql>
        <sql>UPDATE cloudconductor.template as t SET yum = (SELECT id FROM cloudconductor.yumserver as y WHERE y.yumpath
            = t.yum_old)
        </sql>

        <dropColumn tableName="template" columnName="yum_old" schemaName="cloudconductor"/>
    </changeSet>
    <changeSet id="4" author="psigloch">
        <sql>INSERT INTO cloudconductor.servicedefaultstate (serviceid, templateid, state) SELECT ss.serviceid,
            h.templateid, 2 FROM
            cloudconductor.servicestate as ss, cloudconductor.host as h WHERE ss.hostid = h.id;
        </sql>
    </changeSet>
    <changeSet id="5" author="psigloch">
        <addColumn tableName="template" schemaName="cloudconductor">
            <column name="autoupdate" type="boolean" defaultValueBoolean="false"/>
        </addColumn>
    </changeSet>
    <changeSet id="6" author="psigloch">
        <renameTable newTableName="packageversion" oldTableName="rpm" schemaName="cloudconductor"/>
    </changeSet>

    <changeSet id="7" author="psigloch">
        <createTable tableName="serveroptions" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="bgcolor" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
            <column name="allowautoupdate" type="boolean" defaultValue="true">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(1024)"/>
        </createTable>
        <createTable tableName="additionallinks" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="label" type="varchar(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="url" type="varchar(250)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="auditlog" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="timestamp" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="username" type="varchar(250)"/>
            <column name="entry" type="varchar(1024)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <sql>INSERT INTO cloudconductor.serveroptions (name, bgcolor, allowautoupdate) VALUES ('Default', 'F6F4F0',
            true)
        </sql>
        <sql>INSERT INTO cloudconductor.additionallinks (label, url) VALUES ('Report',
            'http://localhost:8090/web/report')
        </sql>
    </changeSet>
    <changeSet id="8" author="psigloch">
        <addColumn tableName="auditlog" schemaName="cloudconductor">
            <column name="category" type="integer">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="9" author="psigloch">
        <renameTable newTableName="file" oldTableName="configfile" schemaName="cloudconductor"/>
        <renameTable newTableName="filedata" oldTableName="configdata" schemaName="cloudconductor"/>
        <renameColumn tableName="filedata" oldColumnName="configfileid" newColumnName="fileid"
                      schemaName="cloudconductor"
                      columnDataType="bigint"/>
        <renameTable newTableName="mappingfileservice" oldTableName="mappingconfigfileservice"
                     schemaName="cloudconductor"/>
        <renameColumn tableName="mappingfileservice" oldColumnName="configfileid" newColumnName="fileid"
                      schemaName="cloudconductor"
                      columnDataType="bigint"/>
        <renameTable newTableName="mappingfiletemplate" oldTableName="mappingconfigfiletemplate"
                     schemaName="cloudconductor"/>
        <renameColumn tableName="mappingfiletemplate" oldColumnName="configfileid" newColumnName="fileid"
                      schemaName="cloudconductor"
                      columnDataType="bigint"/>
    </changeSet>

    <changeSet id="10" author="psigloch">
        <addColumn tableName="template" schemaName="cloudconductor">
            <column name="smoothupdate" type="boolean" defaultValueBoolean="false"/>
        </addColumn>
        <addColumn tableName="host" schemaName="cloudconductor">
            <column name="startedupdate" type="bigint"/>
        </addColumn>
    </changeSet>

    <changeSet id="11" author="psigloch">
        <addColumn tableName="serveroptions" schemaName="cloudconductor">
            <column name="needsapproval" type="boolean" defaultValueBoolean="false"/>
        </addColumn>
        <sql>UPDATE cloudconductor.serveroptions SET needsapproval=false WHERE name='Default'</sql>
    </changeSet>

    <changeSet id="12" author="psigloch">
        <createTable tableName="filetag" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(250)">
                <constraints nullable="false"/>
            </column>
            <column name="color" type="integer">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="taggedfiles" schemaName="cloudconductor">
            <column name="fileid" type="bigint">
                <constraints references="cloudconductor.file(id)" foreignKeyName="fk_file_tag" deleteCascade="true"
                             nullable="false"/>
            </column>
            <column name="tagid" type="bigint">
                <constraints references="cloudconductor.filetag(id)" foreignKeyName="fk_tag_file" deleteCascade="true"
                             nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="14" author="psigloch">
        <addColumn schemaName="cloudconductor" tableName="auditlog">
            <column name="audittype" type="integer" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="cloudconductor" tableName="configvalues">
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="deleted" type="boolean" defaultValue="false"></column>
            <column name="origid" type="bigint">
                <constraints references="cloudconductor.configvalues(id)" foreignKeyName="fk_cv_versionized"
                             deleteCascade="true"/>
            </column>
        </addColumn>
        <sql>UPDATE cloudconductor.configvalues as c SET origid=c.id;</sql>
    </changeSet>
    <changeSet id="15" author="psigloch">
        <addColumn schemaName="cloudconductor" tableName="auditlog">
            <column name="elementid" type="integer"/>
            <column name="origrev" type="integer"/>
            <column name="newrev" type="integer"/>
        </addColumn>

        <addColumn schemaName="cloudconductor" tableName="filedata">
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="deleted" type="boolean" defaultValue="false"></column>
            <column name="origid" type="bigint">
                <constraints references="cloudconductor.filedata(id)" foreignKeyName="fk_filedata_versionized"
                             deleteCascade="true"/>
            </column>
        </addColumn>
        <sql>UPDATE cloudconductor.filedata as f SET origid=f.id;</sql>
        <addColumn schemaName="cloudconductor" tableName="file">
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="deleted" type="boolean" defaultValue="false"></column>
            <column name="origid" type="bigint">
                <constraints references="cloudconductor.file(id)" foreignKeyName="fk_file_versionized"
                             deleteCascade="true"/>
            </column>
        </addColumn>
        <sql>UPDATE cloudconductor.file as f SET origid=f.id;</sql>
    </changeSet>

    <changeSet id="16" author="psigloch">
        <addUniqueConstraint schemaName="cloudconductor" tableName="mappingrpmtemplate" columnNames="templateid, rpmid"
                             constraintName="mappingrpmtemplate_constraint"/>
        <addUniqueConstraint schemaName="cloudconductor" tableName="mappinghostsvcst" columnNames="hostid, svcstid"
                             constraintName="mappinghostsvcst_constraint"/>
        <addUniqueConstraint schemaName="cloudconductor" tableName="mappingtemplatehost"
                             columnNames="templateid, hostid" constraintName="mappingtemplatehost_constraint"/>
        <addUniqueConstraint schemaName="cloudconductor" tableName="servicedefaultstate"
                             columnNames="templateid, serviceid" constraintName="servicedefaultstate_constraint"/>
    </changeSet>
    <changeSet id="17" author="psigloch">
        <addColumn schemaName="cloudconductor" tableName="servicedefaultstate">
            <column name="newstate" type="bigint" defaultValue="4">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn schemaName="cloudconductor" tableName="servicestate">
            <column name="newstate" type="bigint" defaultValue="4">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <sql>
            --UNKNOWN(0) -> STOPPED(4)
            UPDATE cloudconductor.servicedefaultstate SET newstate=4 WHERE state=0;
            UPDATE cloudconductor.servicestate SET newstate=4 WHERE state=0;

            --RUNNING(1) -> STARTED(1)
            UPDATE cloudconductor.servicedefaultstate SET newstate=1 WHERE state=1;
            UPDATE cloudconductor.servicestate SET newstate=1 WHERE state=1;

            --STOPPED(2) -> STOPPED(4)
            UPDATE cloudconductor.servicedefaultstate SET newstate=4 WHERE state=2;
            UPDATE cloudconductor.servicestate SET newstate=4 WHERE state=2;

            --STARTING(3) -> STARTING(0)
            UPDATE cloudconductor.servicedefaultstate SET newstate=0 WHERE state=3;
            UPDATE cloudconductor.servicestate SET newstate=0 WHERE state=3;

            --STOPPING(4) -> STOPPING(3)
            UPDATE cloudconductor.servicedefaultstate SET newstate=3 WHERE state=4;
            UPDATE cloudconductor.servicestate SET newstate=3 WHERE state=4;

            --RESTARTING(5) -> RESTARTING_STOPPING(5)
            UPDATE cloudconductor.servicedefaultstate SET newstate=5 WHERE state=5;
            UPDATE cloudconductor.servicestate SET newstate=5 WHERE state=5;

            --RESTARTED(6) -> RESTARTING_STARTING(6)
            UPDATE cloudconductor.servicedefaultstate SET newstate=6 WHERE state=6;
            UPDATE cloudconductor.servicestate SET newstate=6 WHERE state=6;
        </sql>
        <dropColumn schemaName="cloudconductor" tableName="servicedefaultstate" columnName="state"/>
        <dropColumn schemaName="cloudconductor" tableName="servicestate" columnName="state"/>

        <renameColumn schemaName="cloudconductor" tableName="servicedefaultstate" oldColumnName="newstate"
                      newColumnName="state"/>
        <renameColumn schemaName="cloudconductor" tableName="servicestate" oldColumnName="newstate"
                      newColumnName="state"/>
    </changeSet>
    <changeSet id="18" author="psigloch">
        <addColumn schemaName="cloudconductor" tableName="serveroptions">
            <column name="hostcleanuptimer" defaultValueNumeric="30" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="hostcleanuptimerunit" defaultValueNumeric="3" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="indexscantimer" defaultValueNumeric="60" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="indexscantimerunit" defaultValueNumeric="3" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="pagerefreshtimer" defaultValueNumeric="15" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="pagerefreshtimerunit" defaultValueNumeric="3" type="bigint">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <createTable schemaName="cloudconductor" tableName="serveroptions_disallowuninstall">
            <column name="id" type="bigint">
                <constraints references="cloudconductor.serveroptions(id)" foreignKeyName="fk_serveroptions_uninstall"
                             deleteCascade="true" nullable="false"/>
            </column>
            <column name="disallowuninstall" type="text"/>
        </createTable>

        <sql>INSERT INTO cloudconductor.serveroptions_disallowuninstall(id, disallowuninstall) SELECT id, 'jdk' FROM
            cloudconductor.serveroptions LIMIT 1;
        </sql>

        <createTable schemaName="cloudconductor" tableName="agentoption">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="templateid" type="bigint">
                <constraints nullable="false" references="cloudconductor.template(id)"
                             foreignKeyName="fk_template_agent_option" deleteCascade="true"/>
            </column>
            <column name="alivetimer" defaultValueNumeric="2" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="alivetimerunit" defaultValueNumeric="4" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="dosshkeys" defaultValueNumeric="2" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="sshkeystimer" defaultValueNumeric="5" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="sshkeystimerunit" defaultValueNumeric="4" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="dopackagemanagement" defaultValueNumeric="2" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="packagemanagementtimer" defaultValueNumeric="2" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="packagemanagementtimerunit" defaultValueNumeric="4" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="dofilemanagement" defaultValueNumeric="2" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="filemanagementtimer" defaultValueNumeric="2" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="filemanagementtimerunit" defaultValueNumeric="4" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="19" author="psigloch">
        <addColumn schemaName="cloudconductor" tableName="host">
            <column name="executedssh" type="boolean" defaultValueBoolean="false"/>
            <column name="executedfiles" type="boolean" defaultValueBoolean="false"/>
            <column name="executedpkg" type="boolean" defaultValueBoolean="false"/>
        </addColumn>
    </changeSet>
    <changeSet id="20" author="jawe09">
        <createTable tableName="directory" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(150)">
                <constraints nullable="false"/>
            </column>
            <column name="targetpath" type="text">
                <constraints nullable="false"/>
            </column>
            <column name="owner" type="varchar(150)">
                <constraints nullable="false"/>
            </column>
            <column name="filegroup" type="varchar(150)">
                <constraints nullable="false"/>
            </column>
            <column name="filemode" type="varchar(150)">
                <constraints nullable="false"/>
            </column>
            <column name="packageid" type="bigint">
                <constraints references="cloudconductor.package(id)" foreignKeyName="fk_directory_pkg"
                             deleteCascade="true"/>
            </column>
        </createTable>
        <createTable tableName="mappingdirectoryservice" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="directoryid" type="bigint">
                <constraints references="cloudconductor.directory(id)" foreignKeyName="fk_directory_svc"
                             deleteCascade="true"/>
            </column>
            <column name="serviceid" type="bigint">
                <constraints references="cloudconductor.service(id)" foreignKeyName="fk_svc_directory"
                             deleteCascade="true"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="21" author="jawe09">
        <addColumn schemaName="cloudconductor" tableName="directory">
            <column name="version" type="bigint" defaultValue="0">
                <constraints nullable="false"/>
            </column>
            <column name="deleted" type="boolean" defaultValue="false"></column>
            <column name="origid" type="bigint">
                <constraints references="cloudconductor.directory(id)" foreignKeyName="fk_directory_versionized"
                             deleteCascade="true"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="22" author="jawe09">
        <createTable tableName="mappingdirectorytemplate" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="directoryid" type="bigint">
                <constraints nullable="false" references="cloudconductor.directory(id)"
                             foreignKeyName="fk_directory_template"
                             deleteCascade="true"/>
            </column>
            <column name="templateid" type="bigint">
                <constraints nullable="false" references="cloudconductor.template(id)"
                             foreignKeyName="fk_template_directory"
                             deleteCascade="true"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet id="20" author="ablehm">
        <createTable schemaName="cloudconductor" tableName="agentauthtoken">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="token" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="creationdate" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="revoked" type="bigint"/>
            <column name="revokecomment" type="varchar(500)">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <createTable schemaName="cloudconductor" tableName="agent">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="agentauthtokenid" type="bigint">
                <constraints references="cloudconductor.agentauthtoken(id)" foreignKeyName="fk_agent_auth_token_agent"
                             deleteCascade="false"/>
            </column>
            <column name="tokenassociationdate" type="bigint"/>
        </createTable>
        <addColumn schemaName="cloudconductor" tableName="host">
            <column name="agentid" type="bigint">
                <constraints references="cloudconductor.agent(id)" foreignKeyName="fk_agent_host"
                             deleteCascade="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="21" author="psigloch">
        <dropColumn schemaName="cloudconductor" tableName="serveroptions" columnName="bgcolor"/>
    </changeSet>
    <changeSet id="22" author="psigloch">
        <createTable schemaName="cloudconductor" tableName="repo">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="primarymirrorid" type="bigint">
                <constraints nullable="true"/>
            </column>
            <column name="description" type="text">
                <constraints nullable="true"/>
            </column>
            <column name="lastindex" type="bigint">
                <constraints nullable="true"/>
            </column>
        </createTable>

        <insert schemaName="cloudconductor" tableName="repo">
            <column name="name" value="Base-Repo"/>
            <column name="description" value="The default repository"/>
        </insert>

        <renameTable schemaName="cloudconductor" newTableName="repomirror" oldTableName="yumserver"/>
        <addColumn schemaName="cloudconductor" tableName="repomirror">
            <column name="repoid" type="bigint" defaultValue="1">
                <constraints nullable="false" references="cloudconductor.repo(id)" foreignKeyName="fk_repo_mirror"
                             deleteCascade="true"/>
            </column>
            <column name="indexertype" type="int" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="providertype" type="int" defaultValue="1">
                <constraints nullable="false"/>
            </column>
            <column name="basepath" type="varchar(255)"/>
            <column name="bucketname" type="varchar(255)"/>
            <column name="awsregion" type="varchar(255)"/>
            <column name="accesskeyid" type="varchar(255)"/>
            <column name="secretkey" type="varchar(255)"/>
        </addColumn>
        <update tableName="repomirror" schemaName="cloudconductor">
            <column name="repoid" value="1"/>
        </update>

        <createTable schemaName="cloudconductor" tableName="map_version_repo">
            <column name="versionid" type="bigint">
                <constraints nullable="false" references="cloudconductor.packageversion(id)"
                             foreignKeyName="fk_version_repo" deleteCascade="true"/>
            </column>
            <column name="repoid" type="bigint">
                <constraints nullable="false" references="cloudconductor.repo(id)" foreignKeyName="fk_repo_version"
                             deleteCascade="true"/>
            </column>
        </createTable>

        <sql>INSERT INTO cloudconductor.map_version_repo (versionid, repoid) SELECT id, '1' FROM
            cloudconductor.packageversion;
        </sql>

        <renameColumn schemaName="cloudconductor" tableName="repomirror" oldColumnName="yumpath" newColumnName="path"/>

        <createTable schemaName="cloudconductor" tableName="map_template_repo">
            <column name="templateid" type="bigint">
                <constraints nullable="false" references="cloudconductor.template(id)" foreignKeyName="fk_template_repo"
                             deleteCascade="true"/>
            </column>
            <column name="repoid" type="bigint">
                <constraints nullable="false" references="cloudconductor.repo(id)" foreignKeyName="fk_repo_template"
                             deleteCascade="true"/>
            </column>
        </createTable>

        <sql>INSERT INTO cloudconductor.map_template_repo (templateid, repoid) SELECT id, '1' FROM
            cloudconductor.template;
        </sql>
        <dropColumn schemaName="cloudconductor" tableName="template" columnName="yum"/>
    </changeSet>
    <changeSet id="23" author="psigloch">
        <dropTable tableName="auditlog" schemaName="cloudconductor"/>
    </changeSet>
    <changeSet id="24" author="psigloch">
        <dropTable tableName="taggedfiles" schemaName="cloudconductor"/>
        <dropTable tableName="filetag" schemaName="cloudconductor"/>
    </changeSet>
    <changeSet id="25" author="mweise">
        <addColumn tableName="sshkey" schemaName="cloudconductor">
            <column name="lastchangeddate" type="bigint"></column>
            <column name="username" type="varchar(255)"></column>
        </addColumn>
    </changeSet>
    <changeSet id="26" author="mweise">
        <addColumn schemaName="cloudconductor" tableName="file">
            <column name="directory" type="boolean"></column>
        </addColumn>
        <addNotNullConstraint schemaName="cloudconductor" tableName="file" columnName="directory"
                              columnDataType="boolean" defaultNullValue="false"/>
    </changeSet>
    <changeSet id="27" author="mweise">
        <dropTable schemaName="cloudconductor" tableName="mappingdirectoryservice"/>
        <dropTable schemaName="cloudconductor" tableName="mappingdirectorytemplate"/>
        <dropTable schemaName="cloudconductor" tableName="directory"/>
    </changeSet>
    <changeSet id="28" author="mweise">
        <addNotNullConstraint schemaName="cloudconductor" tableName="sshkey" columnName="username"
                              columnDataType="varchar(255)" defaultNullValue="root"/>
    </changeSet>
    <changeSet id="29" author="mweise">
        <addUniqueConstraint columnNames="name" constraintName="service_name_key" schemaName="cloudconductor"
                             tableName="service"/>
    </changeSet>
    <changeSet id="30" author="mweise">
        <addUniqueConstraint columnNames="packageid,version" constraintName="packageid_version"
                             schemaName="cloudconductor" tableName="packageversion"/>
    </changeSet>
    <changeSet id="31" author="psigloch">

        <createTable tableName="usergroup" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="description" type="text"/>
        </createTable>
        <insert tableName="usergroup" schemaName="cloudconductor">
            <column name="name">Administrator</column>
        </insert>
        <insert tableName="usergroup" schemaName="cloudconductor">
            <column name="name">Agent</column>
        </insert>
        <insert tableName="usergroup" schemaName="cloudconductor">
            <column name="name">Anonymous</column>
        </insert>

        <createTable tableName="usergroup_permissions" schemaName="cloudconductor">
            <column name="group_id" type="bigint">
                <constraints nullable="false" references="cloudconductor.usergroup(id)"
                             foreignKeyName="fk_usergroup_permission"
                             deleteCascade="true"/>
            </column>
            <column name="permission" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <insert tableName="usergroup_permissions" schemaName="cloudconductor">
            <column name="group_id"
                    valueComputed="(SELECT id FROM cloudconductor.usergroup WHERE name ='Administrator')"/>
            <column name="permission">0</column>
        </insert>
        <insert tableName="usergroup_permissions" schemaName="cloudconductor">
            <column name="group_id"
                    valueComputed="(SELECT id FROM cloudconductor.usergroup WHERE name ='Administrator')"/>
            <column name="permission">1</column>
        </insert>
        <insert tableName="usergroup_permissions" schemaName="cloudconductor">
            <column name="group_id"
                    valueComputed="(SELECT id FROM cloudconductor.usergroup WHERE name ='Administrator')"/>
            <column name="permission">2</column>
        </insert>
        <insert tableName="usergroup_permissions" schemaName="cloudconductor">
            <column name="group_id"
                    valueComputed="(SELECT id FROM cloudconductor.usergroup WHERE name ='Administrator')"/>
            <column name="permission">3</column>
        </insert>
        <insert tableName="usergroup_permissions" schemaName="cloudconductor">
            <column name="group_id"
                    valueComputed="(SELECT id FROM cloudconductor.usergroup WHERE name ='Administrator')"/>
            <column name="permission">4</column>
        </insert>
        <insert tableName="usergroup_permissions" schemaName="cloudconductor">
            <column name="group_id"
                    valueComputed="(SELECT id FROM cloudconductor.usergroup WHERE name ='Administrator')"/>
            <column name="permission">5</column>
        </insert>
        <insert tableName="usergroup_permissions" schemaName="cloudconductor">
            <column name="group_id"
                    valueComputed="(SELECT id FROM cloudconductor.usergroup WHERE name ='Administrator')"/>
            <column name="permission">6</column>
        </insert>
        <insert tableName="usergroup_permissions" schemaName="cloudconductor">
            <column name="group_id"
                    valueComputed="(SELECT id FROM cloudconductor.usergroup WHERE name ='Administrator')"/>
            <column name="permission">7</column>
        </insert>
        <insert tableName="usergroup_permissions" schemaName="cloudconductor">
            <column name="group_id"
                    valueComputed="(SELECT id FROM cloudconductor.usergroup WHERE name ='Administrator')"/>
            <column name="permission">8</column>
        </insert>
        <insert tableName="usergroup_permissions" schemaName="cloudconductor">
            <column name="group_id"
                    valueComputed="(SELECT id FROM cloudconductor.usergroup WHERE name ='Administrator')"/>
            <column name="permission">9</column>
        </insert>
        <insert tableName="usergroup_permissions" schemaName="cloudconductor">
            <column name="group_id"
                    valueComputed="(SELECT id FROM cloudconductor.usergroup WHERE name ='Administrator')"/>
            <column name="permission">10</column>
        </insert>
        <insert tableName="usergroup_permissions" schemaName="cloudconductor">
            <column name="group_id"
                    valueComputed="(SELECT id FROM cloudconductor.usergroup WHERE name ='Administrator')"/>
            <column name="permission">11</column>
        </insert>
        <insert tableName="usergroup_permissions" schemaName="cloudconductor">
            <column name="group_id"
                    valueComputed="(SELECT id FROM cloudconductor.usergroup WHERE name ='Administrator')"/>
            <column name="permission">12</column>
        </insert>
        <insert tableName="usergroup_permissions" schemaName="cloudconductor">
            <column name="group_id"
                    valueComputed="(SELECT id FROM cloudconductor.usergroup WHERE name ='Agent')"/>
            <column name="permission">10</column>
        </insert>
        <insert tableName="usergroup_permissions" schemaName="cloudconductor">
            <column name="group_id"
                    valueComputed="(SELECT id FROM cloudconductor.usergroup WHERE name ='Anonymous')"/>
            <column name="permission">4</column>
        </insert>

        <createTable tableName="user" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="loginname" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="roundoffset" type="int"/>
            <column name="hash" type="varchar(255)"/>
            <column name="salt" type="varchar(255)"/>
            <column name="displayname" type="varchar(255)"/>
            <column name="email" type="varchar(255)"/>
            <column name="registrationdate" type="datetime"/>
            <column name="active" type="boolean"/>
        </createTable>
        <insert tableName="user" schemaName="cloudconductor">
            <column name="loginname">admin</column>
            <column name="roundoffset">5000</column>
            <column name="hash">
                15F52B01B7636D5FEC497FAE1ECC23AB5A288AD3B0EC75F366FA607F9F712BD4AAB3F355542FF0475E20AB1C8EDF48A983D7128D860FBC05ABF487DBF14D58ED
            </column>
            <column name="salt">
                932F60D8C4BC62B8F4EE1A342EFE0F220FE9717C0B1E4C44EF66D9717EB703A8AB1C465F74AA34F520C7DC60559FEE3793F8F99FB79A21291C95C5C60441A067
            </column>
            <column name="displayname">Admin</column>
            <column name="registrationdate" valueDate="${now}"/>
            <column name="active">true</column>
        </insert>
        <insert tableName="user" schemaName="cloudconductor">
            <column name="loginname">agent</column>
            <column name="displayname">Agent</column>
            <column name="registrationdate" valueDate="${now}"/>
            <column name="active">true</column>
        </insert>

        <createTable schemaName="cloudconductor" tableName="map_user_usergroup">
            <column name="userid" type="bigint">
                <constraints nullable="false" references="cloudconductor.user(id)" foreignKeyName="fk_user_group"
                             deleteCascade="true"/>
            </column>
            <column name="groupid" type="bigint">
                <constraints nullable="false" references="cloudconductor.usergroup(id)" foreignKeyName="fk_group_user"
                             deleteCascade="true"/>
            </column>
        </createTable>
        <insert tableName="map_user_usergroup" schemaName="cloudconductor">
            <column name="userid" valueComputed="(SELECT id FROM cloudconductor.user WHERE loginname='admin')"/>
            <column name="groupid"
                    valueComputed="(SELECT id FROM cloudconductor.usergroup WHERE name='Administrator')"/>
        </insert>
        <insert tableName="map_user_usergroup" schemaName="cloudconductor">
            <column name="userid" valueComputed="(SELECT id FROM cloudconductor.user WHERE loginname='agent')"/>
            <column name="groupid" valueComputed="(SELECT id FROM cloudconductor.usergroup WHERE name='Agent')"/>
        </insert>

        <createTable tableName="authtoken" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="userid" type="bigint">
                <constraints nullable="false" references="cloudconductor.user(id)" foreignKeyName="fk_authtoken_user"
                             deleteCascade="true"/>
            </column>
            <column name="token" type="varchar(255)"/>
            <column name="creationdate" type="datetime"/>
            <column name="revokedate" type="datetime"/>
        </createTable>
        <sql stripComments="true" dbms="postgresql">
            INSERT INTO cloudconductor.authtoken (userid, token, creationdate) SELECT u.id, a.token,
            to_timestamp(a.creationdate) FROM cloudconductor.user as u, cloudconductor.agentauthtoken as a WHERE
            u.loginname='agent'
            AND a.revoked IS NULL;
        </sql>
        <sql stripComments="true" dbms="hsqldb">
            INSERT INTO cloudconductor.authtoken (userid, token, creationdate) SELECT u.id, a.token,
            TIMESTAMP_WITH_ZONE(a.creationdate) FROM cloudconductor.user as u, cloudconductor.agentauthtoken as a WHERE
            u.loginname='agent'
            AND a.revoked IS NULL;
        </sql>
        <sql stripComments="true" dbms="mysql">
            INSERT INTO cloudconductor.authtoken (userid, token, creationdate) SELECT u.id, a.token,
            FROM_UNIXTIME(a.creationdate) FROM cloudconductor.user as u, cloudconductor.agentauthtoken as a WHERE
            u.loginname='agent'
            AND a.revoked IS NULL;
        </sql>
        <createTable tableName="jwttoken" schemaName="cloudconductor">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="userid" type="bigint">
                <constraints nullable="false" references="cloudconductor.user(id)" foreignKeyName="fk_jwttoken_user"
                             deleteCascade="true"/>
            </column>
            <column name="token" type="text"/>
            <column name="active" type="boolean"/>
            <column name="authtype" type="int"/>
            <column name="reftoken" type="bigint">
                <constraints references="cloudconductor.authtoken(id)"
                             foreignKeyName="fk_jwttoken_authtoken"
                             deleteCascade="true"/>
            </column>
        </createTable>
        <dropColumn tableName="agent" schemaName="cloudconductor" columnName="agentauthtokenid"/>
        <dropColumn tableName="agent" schemaName="cloudconductor" columnName="tokenassociationdate"/>
        <addColumn tableName="agent" schemaName="cloudconductor">
            <column name="userid" type="bigint">
                <constraints nullable="true" references="cloudconductor.user(id)" foreignKeyName="fk_agent_user"
                             deleteCascade="true"/>
            </column>
        </addColumn>
        <update tableName="agent" schemaName="cloudconductor">
            <column name="userid" valueComputed="(SELECT id FROM cloudconductor.user WHERE loginname='agent')"/>
        </update>
        <dropTable tableName="agentauthtoken" schemaName="cloudconductor"/>
    </changeSet>
    <changeSet id="31" author="mweise">
        <addColumn schemaName="cloudconductor" tableName="serveroptions">
            <column name="hostalivetimer" defaultValueNumeric="15" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="hostalivetimerunit" defaultValueNumeric="3" type="bigint">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="32" author="mweise">
        <preConditions onFail="MARK_RAN">
            <or>
                <dbms type="postgresql"/>
                <dbms type="mysql"/>
            </or>
        </preConditions>
        <dropUniqueConstraint schemaName="cloudconductor" tableName="serveroptions"
                              constraintName="serveroptions_name_key"/>
    </changeSet>
    <changeSet id="33" author="mweise">
        <insert tableName="usergroup_permissions" schemaName="cloudconductor">
            <column name="group_id" valueComputed="(SELECT id FROM cloudconductor.usergroup WHERE name = 'Agent')"/>
            <column name="permission">2</column>
        </insert>
    </changeSet>
    <changeSet id="34" author="psigloch">
        <dropForeignKeyConstraint baseTableName="configvalues" baseTableSchemaName="cloudconductor"
                                  constraintName="fk_cv_versionized"/>
        <sql>
            DELETE FROM cloudconductor.configvalues WHERE id IN(SELECT out.id FROM cloudconductor.configvalues as out
            LEFT JOIN cloudconductor.configvalues as a ON a.origId = out.origId AND a.version > out.version WHERE a.id
            IS NOT NULL);
            DELETE FROM cloudconductor.configvalues WHERE deleted = true
        </sql>
        <dropColumn tableName="configvalues" schemaName="cloudconductor" columnName="version"/>
        <dropColumn tableName="configvalues" schemaName="cloudconductor" columnName="deleted"/>
        <dropColumn tableName="configvalues" schemaName="cloudconductor" columnName="origid"/>

        <dropForeignKeyConstraint baseTableName="file" baseTableSchemaName="cloudconductor"
                                  constraintName="fk_file_versionized"/>
        <dropForeignKeyConstraint baseTableName="filedata" baseTableSchemaName="cloudconductor"
                                  constraintName="fk_cdata_cf"/>
        <sql>
            UPDATE cloudconductor.filedata as fd SET fileId = (SELECT out.id FROM cloudconductor.file as out WHERE
            out.origId = fd.origId AND out.version = (SELECT MAX(int.version) FROM cloudconductor.file as int WHERE
            out.origId = int.origId));
            DELETE FROM cloudconductor.file WHERE id IN(SELECT out.id FROM cloudconductor.file as out LEFT JOIN
            cloudconductor.file as a ON a.origId = out.origId AND a.version > out.version WHERE a.id IS NOT NULL);
            DELETE FROM cloudconductor.file WHERE deleted = true;
        </sql>
        <dropColumn tableName="file" schemaName="cloudconductor" columnName="version"/>
        <dropColumn tableName="file" schemaName="cloudconductor" columnName="deleted"/>
        <dropColumn tableName="file" schemaName="cloudconductor" columnName="origid"/>

        <dropForeignKeyConstraint baseTableName="filedata" baseTableSchemaName="cloudconductor"
                                  constraintName="fk_filedata_versionized"/>
        <sql>
            DELETE FROM cloudconductor.filedata WHERE deleted = true;
            DELETE FROM cloudconductor.filedata WHERE id IN(SELECT out.id FROM cloudconductor.filedata as out LEFT JOIN
            cloudconductor.filedata as a ON a.origId = out.origId AND a.version > out.version WHERE a.id IS NOT NULL);
        </sql>
        <dropColumn tableName="filedata" schemaName="cloudconductor" columnName="version"/>
        <dropColumn tableName="filedata" schemaName="cloudconductor" columnName="deleted"/>
        <dropColumn tableName="filedata" schemaName="cloudconductor" columnName="origid"/>

    </changeSet>
    <changeSet id="35" author="mweise">
        <update tableName="serveroptions" schemaName="cloudconductor">
            <column name="hostcleanuptimer" value="30"/>
            <column name="hostcleanuptimerunit" value="4"/>
            <column name="indexscantimer" value="4"/>
            <column name="indexscantimerunit" value="4"/>
            <column name="hostalivetimer" value="2"/>
            <column name="hostalivetimerunit" value="4"/>
            <where>name='Default'</where>
        </update>
    </changeSet>

    <changeSet id="36" author="psigloch">
        <addColumn tableName="repo" schemaName="cloudconductor">
            <column name="lastindexhash" type="varchar(255)"/>
        </addColumn>
    </changeSet>
    <changeSet id="37" author="psigloch">
        <addColumn tableName="host" schemaName="cloudconductor">
            <column name="uuid" type="varchar(255)"/>
        </addColumn>
    </changeSet>
    <changeSet id="38" author="psigloch">
        <sql>
            UPDATE cloudconductor.repomirror SET basepath = path WHERE basepath IS NULL AND providertype = 1;
        </sql>
    </changeSet>
    <changeSet id="39" author="psigloch">
        <addColumn tableName="template" schemaName="cloudconductor">
            <column name="groupname" type="varchar(255)"/>
        </addColumn>
    </changeSet>
    <changeSet id="40" author="psigloch">
        <createTable tableName="file_template" schemaName="cloudconductor">
            <column name="file_id" type="bigint"/>
            <column name="template" type="varchar(1024)"/>
        </createTable>
        <createTable tableName="file_services" schemaName="cloudconductor">
            <column name="file_id" type="bigint"/>
            <column name="service" type="varchar(1024)"/>
        </createTable>
        <sql>
            INSERT INTO cloudconductor.file_template(file_id, template) SELECT mft.fileid, t.name FROM
            cloudconductor.mappingfiletemplate as mft, cloudconductor.template as t WHERE mft.templateid = t.id;
            INSERT INTO cloudconductor.file_services(file_id, service) SELECT mfs.fileid, s.name FROM
            cloudconductor.mappingfileservice as mfs, cloudconductor.service as s WHERE mfs.serviceid = s.id;
        </sql>
        <dropTable tableName="mappingfileservice" schemaName="cloudconductor"/>
        <dropTable tableName="mappingfiletemplate" schemaName="cloudconductor"/>
    </changeSet>

    <changeSet id="41" author="psigloch">
        <addColumn tableName="packageversion" schemaName="cloudconductor">
            <column name="pkgname" type="varchar(255)"/>
        </addColumn>
        <sql>
            UPDATE cloudconductor.packageversion as pv SET pkgname=(SELECT pk.name FROM cloudconductor.package as pk
            WHERE pv.packageid = pk.id);
        </sql>

        <addColumn tableName="servicestate" schemaName="cloudconductor">
            <column name="servicename" type="varchar(255)"/>
        </addColumn>
        <sql>
            UPDATE cloudconductor.servicestate as ss SET serviceName=(SELECT s.name FROM cloudconductor.service as s
            WHERE ss.serviceId = s.id);
        </sql>

        <addColumn tableName="packagestate" schemaName="cloudconductor">
            <column name="pkgid" type="bigint"/>
            <column name="pkgname" type="varchar(255)"/>
            <column name="version" type="varchar(255)"/>
        </addColumn>
        <sql>
            UPDATE cloudconductor.packagestate as ps SET
            pkgid=(SELECT pv.packageid FROM cloudconductor.packageversion as pv WHERE pv.id = ps.rpmid),
            pkgname=(SELECT pv.pkgname FROM cloudconductor.packageversion as pv WHERE pv.id = ps.rpmid),
            version=(SELECT pv.version FROM cloudconductor.packageversion as pv WHERE pv.id = ps.rpmid);
        </sql>

        <dropColumn schemaName="cloudconductor" tableName="mappinghostsvcst" columnName="id"/>
        <dropColumn schemaName="cloudconductor" tableName="mappingrpmdep" columnName="id"/>
        <dropColumn schemaName="cloudconductor" tableName="mappingrpmtemplate" columnName="id"/>
        <dropColumn schemaName="cloudconductor" tableName="mappingsvcpkg" columnName="id"/>
        <dropColumn schemaName="cloudconductor" tableName="mappingtemplatehost" columnName="id"/>
        <dropColumn schemaName="cloudconductor" tableName="mappingtemplatesshkey" columnName="id"/>

    </changeSet>
    <changeSet id="e11c17a7-11aa-427d-9df8-18a93dc1d14b" author="psigloch">
        <dropColumn schemaName="cloudconductor" tableName="packageversion" columnName="deprecated" />
    </changeSet>
    <changeSet id="bf3758b8-3127-4375-9b65-e935f222a9dc" author="mweise">
        <addColumn schemaName="cloudconductor" tableName="template">
            <column name="updaterange" type="int" defaultValue="0" />
        </addColumn>
    </changeSet>
    <changeSet id="4e0628c3-85d1-45cd-a1c8-f97233322a5d" author="mweise">
        <addColumn schemaName="cloudconductor" tableName="template">
            <column name="nouninstalls" type="boolean" defaultValueBoolean="false" />
        </addColumn>
    </changeSet>
</databaseChangeLog>
